name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.6.2)'
        required: true
        default: 'v0.6.2'
        type: string
  push:
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ğŸš€ Node.js è®¾ç½®
    - name: Setup Node.js with built-in caching
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'
    
    # â˜• Java å·¥å…·é“¾è®¾ç½®
    - name: Setup Java with caching
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    # ğŸ“± Android SDK è®¾ç½®
    - name: Setup Android SDK with caching
      uses: android-actions/setup-android@v3
    
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/sdk
          ~/.android/avd/*.ini
          ~/.android/avd/*/snapshots
        key: ${{ runner.os }}-android-sdk-${{ hashFiles('android/app/build.gradle', 'android/build.gradle') }}
        restore-keys: |
          ${{ runner.os }}-android-sdk-
    
    # ğŸ¯ Gradle æ„å»ºç¼“å­˜
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/daemon
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # ğŸš„ Metro Bundler ç¼“å­˜
    - name: Cache Metro Bundler
      uses: actions/cache@v4
      with:
        path: |
          ~/.metro
          node_modules/.cache/metro
          android/app/build/generated/res/react
        key: ${{ runner.os }}-metro-${{ hashFiles('metro.config.js', 'babel.config.js', 'package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-metro-${{ hashFiles('metro.config.js', 'babel.config.js') }}-
          ${{ runner.os }}-metro-
    
    # ğŸ“¦ å®‰è£…ä¾èµ–
    - name: Install dependencies with cache optimization
      run: |
        # ä½¿ç”¨npm ciè¿›è¡Œæ›´å¿«çš„å®‰è£…
        npm ci --prefer-offline --no-audit --progress=false
    
    # ğŸ”„ åŒæ­¥ç‰ˆæœ¬å·åˆ°package.json
    - name: Sync version to package.json
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        TAG_VERSION="${{ github.ref_name }}"
        # ç§»é™¤vå‰ç¼€ï¼Œè·å–çº¯ç‰ˆæœ¬å·
        VERSION=${TAG_VERSION#v}
        echo "ğŸ“ Syncing version $VERSION to package.json..."
        
        # ä½¿ç”¨Node.jsæ›´æ–°package.jsonç‰ˆæœ¬
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.version = '$VERSION';
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          console.log('âœ… Updated package.json version to:', pkg.version);
        "

    # ğŸ”¨ ç”Ÿæˆæ„å»ºä¿¡æ¯
    - name: Generate build info
      run: |
        echo "ğŸ“ Generating build info..."
        npm run generate-build-info
        echo "âœ… Build info generated"
    
    # ğŸ”§ Gradle æƒé™å’Œç¼“å­˜é¢„çƒ­
    - name: Setup Gradle with permissions and cache warmup
      run: |
        chmod +x android/gradlew
        # Gradle daemoné¢„çƒ­
        cd android && ./gradlew --version
        
        # é¢„æ„å»ºReact Nativeä¾èµ–ä»¥é¿å…è¶…æ—¶
        echo "ğŸš€ Pre-building React Native native modules..."
        cd android && ./gradlew :app:preBuild \
          --build-cache \
          --parallel \
          --daemon \
          --no-scan \
          --max-workers=2 \
          --quiet \
          || echo "âš ï¸  Pre-build completed with warnings"
    
    # ğŸ” è®¾ç½®ç­¾åè¯ä¹¦
    - name: Setup keystore
      run: |
        # Create secure temporary directory
        TEMP_DIR=$(mktemp -d)
        KEYSTORE_PATH="$TEMP_DIR/release.keystore"
        KEYSTORE_PROPS="$TEMP_DIR/keystore.properties"
        
        # Create keystore from base64 secret in secure temp directory
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > "$KEYSTORE_PATH"
        
        # Create keystore.properties file in temp directory
        cat > "$KEYSTORE_PROPS" << EOF
        RELEASE_STORE_FILE=release.keystore
        RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
        RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
        RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
        EOF
        
        # Move to android directory for gradle access
        mv "$KEYSTORE_PATH" android/app/release.keystore
        mv "$KEYSTORE_PROPS" android/keystore.properties
        
        # Set restrictive permissions
        chmod 600 android/app/release.keystore
        chmod 600 android/keystore.properties
        
        echo "ğŸ” Keystore configured securely"
    
    # ğŸš€ æ„å»º Android APK
    - name: Build Android APK
      timeout-minutes: 45
      run: |
        cd android
        
        echo "ğŸ“± Starting Android APK build..."
        
        # Pre-build validation
        if [[ ! -f "keystore.properties" ]]; then
          echo "âŒ ERROR: keystore.properties not found!"
          exit 1
        fi
        
        if [[ ! -f "app/release.keystore" ]]; then
          echo "âŒ ERROR: release.keystore not found!"
          exit 1
        fi
        
        # Build with comprehensive error handling
        set +e  # Don't exit immediately on error so we can capture logs
        
        ./gradlew assembleRelease \
          --build-cache \
          --parallel \
          --daemon \
          --no-scan \
          --stacktrace \
          --max-workers=3 \
          2>&1 | tee build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        # Check if build failed
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "âŒ Gradle build failed with exit code $BUILD_EXIT_CODE!"
          echo "=============== EXTRACTING ERROR DETAILS ==============="
          # Extract Kotlin compilation errors
          echo "--- Searching for Kotlin errors (e:) ---"
          grep -E "^e: " build.log || echo "No 'e:' errors found"
          echo ""
          echo "--- Searching for compilation failures ---"
          grep -B 5 -A 10 "compileReleaseKotlin" build.log | grep -E "e: |error:|FAILED" || echo "No compilation errors found"
          echo ""
          echo "--- Last 100 lines with 'error' keyword ---"
          tail -100 build.log | grep -i "error" || echo "No error keyword found"
          echo "========================================================="
          exit $BUILD_EXIT_CODE
        fi
        
        echo "âœ… Android APK build completed successfully"
        
        # Post-build verification
        APK_DIR="app/build/outputs/apk/release"
        echo "ğŸ“¦ Verifying build outputs in $APK_DIR..."
        
        if [[ ! -d "$APK_DIR" ]]; then
          echo "âŒ ERROR: APK output directory not found!"
          exit 1
        fi
        
        APK_COUNT=$(find "$APK_DIR" -name "*.apk" | wc -l)
        echo "ğŸ¯ Found $APK_COUNT APK files"
        
        if [[ $APK_COUNT -eq 0 ]]; then
          echo "âŒ ERROR: No APK files were generated!"
          exit 1
        fi
        
        # List all generated APKs with sizes
        echo "ğŸ“‹ Generated APK files:"
        find "$APK_DIR" -name "*.apk" -exec ls -lh {} \;
      env:
        # Gradleä¼˜åŒ–ç¯å¢ƒå˜é‡
        GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
        ANDROID_COMPILE_SDK: "34"
        ANDROID_BUILD_TOOLS: "34.0.0"
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
    
    # ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload All APKs as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: musicfree-${{ github.event.inputs.version || github.ref_name }}-all-apks
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 30
        compression-level: 9
    
    # âœ… éªŒè¯APKæ–‡ä»¶å­˜åœ¨æ€§
    - name: Verify APK files exist
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "ğŸ” Checking APK files..."
        APK_DIR="android/app/build/outputs/apk/release"
        ls -la $APK_DIR/
        
        # Verify all expected APK files exist
        MISSING_FILES=()
        EXPECTED_FILES=(
          "app-universal-release.apk"
          "app-arm64-v8a-release.apk" 
          "app-armeabi-v7a-release.apk"
          "app-x86_64-release.apk"
          "app-x86-release.apk"
        )
        
        for file in "${EXPECTED_FILES[@]}"; do
          if [[ ! -f "$APK_DIR/$file" ]]; then
            MISSING_FILES+=("$file")
            echo "âŒ Missing: $file"
          else
            echo "âœ… Found: $file"
          fi
        done
        
        if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
          echo "ğŸš¨ ERROR: ${#MISSING_FILES[@]} APK files are missing!"
          exit 1
        else
          echo "ğŸ‰ All APK files are present!"
        fi

    # ğŸ‰ åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰APK
    - name: Create Release and Upload APKs
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: MusicFree ${{ github.ref_name }}
        body: |
          ## ğŸµ MusicFree ${{ github.ref_name }}
          
          ### ğŸ“± ä¸‹è½½é€‰é¡¹
          
          **æ¨èä¸‹è½½ (é€‚ç”¨äºæ‰€æœ‰è®¾å¤‡):**
          - **Universal APK**: [app-universal-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-universal-release.apk)
          
          **æŒ‰è®¾å¤‡æ¶æ„ä¸‹è½½ (ä½“ç§¯æ›´å°):**
          - **ARM64 (æ¨è)**: [app-arm64-v8a-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-arm64-v8a-release.apk) - é€‚ç”¨äºå¤§éƒ¨åˆ†ç°ä»£Androidè®¾å¤‡
          - **ARM32**: [app-armeabi-v7a-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-armeabi-v7a-release.apk) - é€‚ç”¨äºè€ç‰ˆæœ¬Androidè®¾å¤‡
          - **x86_64**: [app-x86_64-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-x86_64-release.apk) - é€‚ç”¨äºx86_64æ¨¡æ‹Ÿå™¨
          - **x86**: [app-x86-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/app-x86-release.apk) - é€‚ç”¨äºx86æ¨¡æ‹Ÿå™¨
          
          ### ğŸ”„ æ›´æ–°å†…å®¹
          
          1. å…¨é¢æ”¯æŒikunéŸ³æº8ç§éŸ³è´¨
          2. ğŸš©è¯·ä½¿ç”¨æ”¹ç‰ˆikunæ’ä»¶
             - åœ¨çº¿å¯¼å…¥åœ°å€ï¼š`https://musicfree.3kddyys.workers.dev/api/subscription.json?key=ä½ çš„å¡å¯†.json`
             - å¯¼å…¥å¤±è´¥è¯·ä½¿ç”¨ä»£ç†ï¼Œå¯¼å…¥ä¸å®Œå…¨è¯·å¤šæ¬¡é‡è¯•ï¼Œä½ äº¦å¯ä»¥è‡ªè¡Œåœ¨æµè§ˆå™¨è®¿é—®ä¸Šè¿°åœ°å€ä»¥è·å–å•ä¸ªæ’ä»¶åœ°å€
          3. ä¸‹è½½é€šçŸ¥ä¸å¤šç§æ–‡ä»¶ååŠŸèƒ½
          4. æ ¹æ®å–œå¥½å®šåˆ¶éŸ³è´¨æ ‡ç­¾
          5. è½¯ä»¶å¯åŠ¨æ—¶æ‰“å¼€æ’­æ”¾è¯¦æƒ…é¡µ
          
          ### âš¡ æ„å»ºä¿¡æ¯
          - æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
          - æäº¤SHA: ${{ github.sha }}
        draft: false
        prerelease: false
        files: |
          android/app/build/outputs/apk/release/app-universal-release.apk
          android/app/build/outputs/apk/release/app-arm64-v8a-release.apk
          android/app/build/outputs/apk/release/app-armeabi-v7a-release.apk
          android/app/build/outputs/apk/release/app-x86_64-release.apk
          android/app/build/outputs/apk/release/app-x86-release.apk

    # ğŸ§¹ å®‰å…¨æ¸…ç†æ­¥éª¤
    - name: Security cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Performing security cleanup..."
        
        # Remove sensitive files regardless of build outcome
        if [[ -f "android/app/release.keystore" ]]; then
          shred -vfz -n 3 android/app/release.keystore 2>/dev/null || rm -f android/app/release.keystore
          echo "âœ… Keystore file cleaned"
        fi
        
        if [[ -f "android/keystore.properties" ]]; then
          shred -vfz -n 3 android/keystore.properties 2>/dev/null || rm -f android/keystore.properties
          echo "âœ… Keystore properties cleaned"
        fi
        
        # Clean any temporary keystore files
        find . -name "*.keystore" -type f -delete 2>/dev/null || true
        find . -name "keystore.properties" -type f -delete 2>/dev/null || true
        
        echo "ğŸ” Security cleanup completed"