name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., v0.6.2)'
        required: true
        default: 'v0.6.2'
        type: string
  push:
    tags:
      - 'v*'

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ğŸš€ Node.js è®¾ç½®
    - name: Setup Node.js with built-in caching
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'package-lock.json'
    
    # â˜• Java å·¥å…·é“¾è®¾ç½®
    - name: Setup Java with caching
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    # ğŸ“± Android SDK è®¾ç½®
    - name: Setup Android SDK with caching
      uses: android-actions/setup-android@v3
    
    - name: Cache Android SDK
      uses: actions/cache@v4
      with:
        path: |
          ~/.android/sdk
          ~/.android/avd/*.ini
          ~/.android/avd/*/snapshots
        key: ${{ runner.os }}-android-sdk-${{ hashFiles('android/app/build.gradle', 'android/build.gradle') }}
        restore-keys: |
          ${{ runner.os }}-android-sdk-
    
    # ğŸ¯ Gradle æ„å»ºç¼“å­˜
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          ~/.gradle/daemon
          android/.gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # ğŸš„ Metro Bundler ç¼“å­˜
    - name: Cache Metro Bundler
      uses: actions/cache@v4
      with:
        path: |
          ~/.metro
          node_modules/.cache/metro
          android/app/build/generated/res/react
        key: ${{ runner.os }}-metro-${{ hashFiles('metro.config.js', 'babel.config.js', 'package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-metro-${{ hashFiles('metro.config.js', 'babel.config.js') }}-
          ${{ runner.os }}-metro-
    
    # ğŸ“¦ å®‰è£…ä¾èµ–
    - name: Install dependencies with cache optimization
      run: |
        # ä½¿ç”¨npm ciè¿›è¡Œæ›´å¿«çš„å®‰è£…
        npm ci --prefer-offline --no-audit --progress=false
    
    # ğŸ”„ ä»tagåŒæ­¥ç‰ˆæœ¬å·åˆ°package.jsonå’Œversion.json
    - name: Update version from tag
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        TAG_VERSION="${{ github.ref_name }}"
        # ç§»é™¤vå‰ç¼€ï¼Œè·å–çº¯ç‰ˆæœ¬å·
        VERSION=${TAG_VERSION#v}
        echo "ğŸ“ Updating version to $VERSION from tag $TAG_VERSION..."

        # æ›´æ–°package.jsonç‰ˆæœ¬
        node -e "
          const fs = require('fs');
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.version = '$VERSION';
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
          console.log('âœ… Updated package.json version to:', pkg.version);
        "

        # æ›´æ–°release/version.json
        node -e "
          const fs = require('fs');
          const version = '$VERSION';
          const tagVersion = '${{ github.ref_name }}';

          // è¯»å–ç°æœ‰çš„ version.jsonï¼Œä¿ç•™ changeLog
          let existingChangeLog = [];
          try {
            const existingData = JSON.parse(fs.readFileSync('release/version.json', 'utf8'));
            existingChangeLog = existingData.changeLog || [];
            console.log('ğŸ“– Preserving existing changeLog:', existingChangeLog);
          } catch (e) {
            console.log('âš ï¸ Could not read existing version.json, will use empty changeLog');
            existingChangeLog = [];
          }

          // ç”Ÿæˆä¸‹è½½é“¾æ¥ï¼ˆä½¿ç”¨æ–°çš„æ–‡ä»¶åæ ¼å¼ï¼‰
          const downloadUrls = [
            'https://github.com/${{ github.repository }}/releases/download/' + tagVersion + '/MusicFree-v' + version + '-arm64-v8a-release.apk',
            'https://github.com/${{ github.repository }}/releases/download/' + tagVersion + '/MusicFree-v' + version + '-universal-release.apk'
          ];

          // åªæ›´æ–° version å’Œ downloadï¼Œä¿ç•™ç°æœ‰çš„ changeLog
          const versionInfo = {
            version: version,
            changeLog: existingChangeLog,
            download: downloadUrls
          };

          fs.writeFileSync('release/version.json', JSON.stringify(versionInfo, null, 2) + '\n');
          console.log('âœ… Updated version.json:', JSON.stringify(versionInfo, null, 2));
        "

    # ğŸ”¨ ç”Ÿæˆæ„å»ºä¿¡æ¯
    - name: Generate build info
      id: build-info
      run: |
        echo "ğŸ“ Generating build info..."
        npm run generate-build-info
        BUILD_TIME=$(node -e "console.log(require('./src/constants/buildInfo.ts').buildInfo.buildTime)")
        echo "build-time=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "âœ… Build info generated"
    
    # ğŸ”§ Gradle æƒé™å’Œç¼“å­˜é¢„çƒ­
    - name: Setup Gradle with permissions and cache warmup
      run: |
        chmod +x android/gradlew
        # Gradle daemoné¢„çƒ­
        cd android && ./gradlew --version
        
        # é¢„æ„å»ºReact Nativeä¾èµ–ä»¥é¿å…è¶…æ—¶
        echo "ğŸš€ Pre-building React Native native modules..."
        cd android && ./gradlew :app:preBuild \
          --build-cache \
          --parallel \
          --daemon \
          --no-scan \
          --max-workers=2 \
          --quiet \
          || echo "âš ï¸  Pre-build completed with warnings"
    
    # ğŸ” è®¾ç½®ç­¾åè¯ä¹¦
    - name: Setup keystore
      run: |
        # Create secure temporary directory
        TEMP_DIR=$(mktemp -d)
        KEYSTORE_PATH="$TEMP_DIR/release.keystore"
        KEYSTORE_PROPS="$TEMP_DIR/keystore.properties"
        
        # Create keystore from base64 secret in secure temp directory
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 -d > "$KEYSTORE_PATH"
        
        # Create keystore.properties file in temp directory
        cat > "$KEYSTORE_PROPS" << EOF
        RELEASE_STORE_FILE=release.keystore
        RELEASE_STORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}
        RELEASE_KEY_ALIAS=${{ secrets.KEY_ALIAS }}
        RELEASE_KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}
        EOF
        
        # Move to android directory for gradle access
        mv "$KEYSTORE_PATH" android/app/release.keystore
        mv "$KEYSTORE_PROPS" android/keystore.properties
        
        # Set restrictive permissions
        chmod 600 android/app/release.keystore
        chmod 600 android/keystore.properties
        
        echo "ğŸ” Keystore configured securely"
    
    # ğŸš€ æ„å»º Android APK
    - name: Build Android APK
      timeout-minutes: 45
      run: |
        cd android
        
        echo "ğŸ“± Starting Android APK build..."
        
        # Pre-build validation
        if [[ ! -f "keystore.properties" ]]; then
          echo "âŒ ERROR: keystore.properties not found!"
          exit 1
        fi
        
        if [[ ! -f "app/release.keystore" ]]; then
          echo "âŒ ERROR: release.keystore not found!"
          exit 1
        fi
        
        # Build with comprehensive error handling
        set +e  # Don't exit immediately on error so we can capture logs
        
        ./gradlew assembleRelease \
          --build-cache \
          --parallel \
          --daemon \
          --no-scan \
          --stacktrace \
          --max-workers=3 \
          2>&1 | tee build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        
        # Check if build failed
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo "âŒ Gradle build failed with exit code $BUILD_EXIT_CODE!"
          echo "=============== EXTRACTING ERROR DETAILS ==============="
          # Extract Kotlin compilation errors
          echo "--- Searching for Kotlin errors (e:) ---"
          grep -E "^e: " build.log || echo "No 'e:' errors found"
          echo ""
          echo "--- Searching for compilation failures ---"
          grep -B 5 -A 10 "compileReleaseKotlin" build.log | grep -E "e: |error:|FAILED" || echo "No compilation errors found"
          echo ""
          echo "--- Last 100 lines with 'error' keyword ---"
          tail -100 build.log | grep -i "error" || echo "No error keyword found"
          echo "========================================================="
          exit $BUILD_EXIT_CODE
        fi
        
        echo "âœ… Android APK build completed successfully"
        
        # Post-build verification
        APK_DIR="app/build/outputs/apk/release"
        echo "ğŸ“¦ Verifying build outputs in $APK_DIR..."
        
        if [[ ! -d "$APK_DIR" ]]; then
          echo "âŒ ERROR: APK output directory not found!"
          exit 1
        fi
        
        APK_COUNT=$(find "$APK_DIR" -name "*.apk" | wc -l)
        echo "ğŸ¯ Found $APK_COUNT APK files"
        
        if [[ $APK_COUNT -eq 0 ]]; then
          echo "âŒ ERROR: No APK files were generated!"
          exit 1
        fi
        
        # List all generated APKs with sizes
        echo "ğŸ“‹ Generated APK files:"
        find "$APK_DIR" -name "*.apk" -exec ls -lh {} \;
      env:
        # Gradleä¼˜åŒ–ç¯å¢ƒå˜é‡
        GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8"
        ANDROID_COMPILE_SDK: "34"
        ANDROID_BUILD_TOOLS: "34.0.0"
        ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
    
    # ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
    - name: Upload All APKs as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: musicfree-${{ github.event.inputs.version || github.ref_name }}-all-apks
        path: android/app/build/outputs/apk/release/*.apk
        retention-days: 30
        compression-level: 9
    
    # âœ… éªŒè¯APKæ–‡ä»¶å­˜åœ¨æ€§
    - name: Verify APK files exist
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "ğŸ” Checking APK files..."
        APK_DIR="android/app/build/outputs/apk/release"
        ls -la $APK_DIR/

        # ä»tagè·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰vå‰ç¼€ï¼‰
        TAG_VERSION="${{ github.ref_name }}"
        VERSION=${TAG_VERSION#v}

        # Verify all expected APK files exist
        MISSING_FILES=()
        EXPECTED_FILES=(
          "MusicFree-v${VERSION}-universal-release.apk"
          "MusicFree-v${VERSION}-arm64-v8a-release.apk"
          "MusicFree-v${VERSION}-armeabi-v7a-release.apk"
          "MusicFree-v${VERSION}-x86_64-release.apk"
          "MusicFree-v${VERSION}-x86-release.apk"
        )

        for file in "${EXPECTED_FILES[@]}"; do
          if [[ ! -f "$APK_DIR/$file" ]]; then
            MISSING_FILES+=("$file")
            echo "âŒ Missing: $file"
          else
            echo "âœ… Found: $file"
          fi
        done

        if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
          echo "ğŸš¨ ERROR: ${#MISSING_FILES[@]} APK files are missing!"
          exit 1
        else
          echo "ğŸ‰ All APK files are present!"
        fi

    # ğŸ“ ç”ŸæˆReleaseæè¿°
    - name: Generate Release Body
      if: startsWith(github.ref, 'refs/tags/')
      id: release-body
      run: |
        echo "ğŸ“ Generating release body from version.json..."

        # ä»tagè·å–ç‰ˆæœ¬å·
        TAG_VERSION="${{ github.ref_name }}"
        VERSION=${TAG_VERSION#v}

        # è¯»å– changeLog å¹¶æ ¼å¼åŒ–
        CHANGELOG=$(node -e "
          const fs = require('fs');
          const versionData = JSON.parse(fs.readFileSync('release/version.json', 'utf8'));
          const changeLog = versionData.changeLog || [];

          // æ ¼å¼åŒ–ä¸º markdown åˆ—è¡¨
          const formattedLog = changeLog.map((item, index) => \`\${index + 1}. \${item}\`).join('\n');

          console.log(formattedLog);
        ")

        # åˆ›å»ºå®Œæ•´çš„ Release æè¿°
        cat > release_body.md << EOF
        ## ğŸµ MusicFree ${{ github.ref_name }}

        ### ğŸ“± ä¸‹è½½é€‰é¡¹

        **æ¨èä¸‹è½½ (é€‚ç”¨äºæ‰€æœ‰è®¾å¤‡):**
        - **Universal APK**: [MusicFree-v${VERSION}-universal-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MusicFree-v${VERSION}-universal-release.apk)

        **æŒ‰è®¾å¤‡æ¶æ„ä¸‹è½½ (ä½“ç§¯æ›´å°):**
        - **ARM64 (æ¨è)**: [MusicFree-v${VERSION}-arm64-v8a-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MusicFree-v${VERSION}-arm64-v8a-release.apk) - é€‚ç”¨äºå¤§éƒ¨åˆ†ç°ä»£Androidè®¾å¤‡
        - **ARM32**: [MusicFree-v${VERSION}-armeabi-v7a-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MusicFree-v${VERSION}-armeabi-v7a-release.apk) - é€‚ç”¨äºè€ç‰ˆæœ¬Androidè®¾å¤‡
        - **x86_64**: [MusicFree-v${VERSION}-x86_64-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MusicFree-v${VERSION}-x86_64-release.apk) - é€‚ç”¨äºx86_64æ¨¡æ‹Ÿå™¨
        - **x86**: [MusicFree-v${VERSION}-x86-release.apk](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MusicFree-v${VERSION}-x86-release.apk) - é€‚ç”¨äºx86æ¨¡æ‹Ÿå™¨

        ### ğŸ”„ æ›´æ–°å†…å®¹

        $CHANGELOG

        ### âš¡ æ„å»ºä¿¡æ¯
        - æ„å»ºæ—¶é—´: ${{ steps.build-info.outputs.build-time }}
        - æäº¤SHA: ${{ github.sha }}
        EOF

        echo "âœ… Release body generated"

    # ğŸ‰ åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ‰€æœ‰APK
    - name: Create Release and Upload APKs
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TZ: Asia/Shanghai
      with:
        tag_name: ${{ github.ref_name }}
        name: MusicFree ${{ github.ref_name }}
        body_path: release_body.md
        draft: false
        prerelease: false
        files: |
          android/app/build/outputs/apk/release/MusicFree-*.apk

    # ğŸ“¤ æäº¤æ›´æ–°çš„ç‰ˆæœ¬æ–‡ä»¶å›åˆ°ä»“åº“
    - name: Commit updated version files
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        echo "ğŸ“ Committing updated version files..."

        # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        git config --local user.email "3ssa@163.com"
        git config --local user.name "Toskysun"

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        CHANGED_FILES=""
        if ! git diff --quiet package.json; then
          CHANGED_FILES="$CHANGED_FILES package.json"
        fi
        if ! git diff --quiet release/version.json; then
          CHANGED_FILES="$CHANGED_FILES release/version.json"
        fi

        if [ -z "$CHANGED_FILES" ]; then
          echo "â„¹ï¸ No changes to version files, skipping commit"
        else
          echo "ğŸ“ Changes detected in: $CHANGED_FILES"
          git add package.json release/version.json
          git commit -m "chore: update version to ${{ github.ref_name }} [skip ci]"

          # Push to master branch directly
          echo "ğŸ“¤ Pushing version files to master..."
          git push origin HEAD:master
          echo "âœ… Version files updated and pushed to master branch"
        fi

    # ğŸ§¹ å®‰å…¨æ¸…ç†æ­¥éª¤
    - name: Security cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Performing security cleanup..."
        
        # Remove sensitive files regardless of build outcome
        if [[ -f "android/app/release.keystore" ]]; then
          shred -vfz -n 3 android/app/release.keystore 2>/dev/null || rm -f android/app/release.keystore
          echo "âœ… Keystore file cleaned"
        fi
        
        if [[ -f "android/keystore.properties" ]]; then
          shred -vfz -n 3 android/keystore.properties 2>/dev/null || rm -f android/keystore.properties
          echo "âœ… Keystore properties cleaned"
        fi
        
        # Clean any temporary keystore files
        find . -name "*.keystore" -type f -delete 2>/dev/null || true
        find . -name "keystore.properties" -type f -delete 2>/dev/null || true
        
        echo "ğŸ” Security cleanup completed"