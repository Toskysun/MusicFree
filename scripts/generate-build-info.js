#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

// 获取当前日期时间（带时区）
const now = new Date();
const tzOffset = -now.getTimezoneOffset();
const tzSign = tzOffset >= 0 ? '+' : '-';
const tzHours = Math.floor(Math.abs(tzOffset) / 60).toString().padStart(2, '0');
const tzMinutes = (Math.abs(tzOffset) % 60).toString().padStart(2, '0');

// 格式化为 YYYY-MM-DDTHH:mm:ss+08:00 格式
const year = now.getFullYear();
const month = (now.getMonth() + 1).toString().padStart(2, '0');
const day = now.getDate().toString().padStart(2, '0');
const hours = now.getHours().toString().padStart(2, '0');
const minutes = now.getMinutes().toString().padStart(2, '0');
const seconds = now.getSeconds().toString().padStart(2, '0');

const buildTime = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${tzSign}${tzHours}:${tzMinutes}`;

// 获取 Git 信息（如果可用）
let gitCommit = 'unknown';
let gitBranch = 'unknown';

try {
    const { execSync } = require('child_process');
    gitCommit = execSync('git rev-parse --short HEAD', { encoding: 'utf-8' }).trim();
    gitBranch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf-8' }).trim();
} catch (e) {
    console.log('Git信息获取失败，使用默认值');
}

// 生成构建信息文件内容
const content = `// 此文件由构建脚本自动生成，请勿手动修改
// This file is auto-generated by build script, do not edit manually
// Build time: ${buildTime}

export const buildInfo = {
    buildTime: "${buildTime}",
    gitCommit: "${gitCommit}",
    gitBranch: "${gitBranch}",
};

export default buildInfo;`;

// 写入文件
const outputPath = path.join(__dirname, '../src/constants/buildInfo.ts');
fs.writeFileSync(outputPath, content, 'utf-8');

console.log('✅ 构建信息已生成:');
console.log(`   构建时间: ${buildTime}`);
console.log(`   Git Commit: ${gitCommit}`);
console.log(`   Git Branch: ${gitBranch}`);